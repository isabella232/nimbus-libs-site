<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chronos | Nimbus Libraries</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/assets/img/logo.png">
    <meta name="description" content="Ethereum 2.0 utilities and more">
    
    <link rel="preload" href="/assets/css/0.styles.74783a08.css" as="style"><link rel="preload" href="/assets/js/app.b6b895fe.js" as="script"><link rel="preload" href="/assets/js/2.fd7e9e0b.js" as="script"><link rel="preload" href="/assets/js/10.a7e5f96d.js" as="script"><link rel="prefetch" href="/assets/js/11.b620ddcc.js"><link rel="prefetch" href="/assets/js/12.cf1bd068.js"><link rel="prefetch" href="/assets/js/13.9dfac9d9.js"><link rel="prefetch" href="/assets/js/14.1ce3f7fe.js"><link rel="prefetch" href="/assets/js/3.c5869ccf.js"><link rel="prefetch" href="/assets/js/4.b9b777bd.js"><link rel="prefetch" href="/assets/js/5.073c37d9.js"><link rel="prefetch" href="/assets/js/6.7db49fe2.js"><link rel="prefetch" href="/assets/js/7.852d0869.js"><link rel="prefetch" href="/assets/js/8.b8ee59fd.js"><link rel="prefetch" href="/assets/js/9.249d32d4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74783a08.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="Nimbus Libraries" class="logo"> <span class="site-name can-hide">Nimbus Libraries</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/lib/nim-libp2p/" class="nav-link">
  libp2p
</a></div><div class="nav-item"><a href="/lib/nim-chronicles/" class="nav-link">
  Chronicles
</a></div><div class="nav-item"><a href="/lib/nimcrypto/" class="nav-link">
  Nimcrypto
</a></div><div class="nav-item"><a href="/lib/nim-chronos/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Chronos
</a></div><div class="nav-item"><a href="/lib/nim-eth/" class="nav-link">
  Eth
</a></div><div class="nav-item"><a href="/lib/nim-stew/" class="nav-link">
  Stew
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/lib/nim-libp2p/" class="nav-link">
  libp2p
</a></div><div class="nav-item"><a href="/lib/nim-chronicles/" class="nav-link">
  Chronicles
</a></div><div class="nav-item"><a href="/lib/nimcrypto/" class="nav-link">
  Nimcrypto
</a></div><div class="nav-item"><a href="/lib/nim-chronos/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Chronos
</a></div><div class="nav-item"><a href="/lib/nim-eth/" class="nav-link">
  Eth
</a></div><div class="nav-item"><a href="/lib/nim-stew/" class="nav-link">
  Stew
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Chronos</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/lib/nim-chronos/#installation" class="sidebar-link">Installation</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/lib/nim-chronos/#projects-using-chronos" class="sidebar-link">Projects using chronos</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/lib/nim-chronos/#documentation" class="sidebar-link">Documentation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lib/nim-chronos/#concepts" class="sidebar-link">Concepts</a></li><li class="sidebar-sub-header"><a href="/lib/nim-chronos/#dispatcher" class="sidebar-link">Dispatcher</a></li><li class="sidebar-sub-header"><a href="/lib/nim-chronos/#async-procedures-and-methods" class="sidebar-link">Async procedures and methods</a></li><li class="sidebar-sub-header"><a href="/lib/nim-chronos/#error-handling" class="sidebar-link">Error handling</a></li><li class="sidebar-sub-header"><a href="/lib/nim-chronos/#platform-independence" class="sidebar-link">Platform independence</a></li><li class="sidebar-sub-header"><a href="/lib/nim-chronos/#exception-effects" class="sidebar-link">Exception effects</a></li></ul></li><li><a href="/lib/nim-chronos/#todo" class="sidebar-link">TODO</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="chronos"><a href="#chronos" class="header-anchor">#</a> Chronos</h1> <p>Chronos is an efficient <a href="https://en.wikipedia.org/wiki/Async/await" target="_blank" rel="noopener noreferrer">async/await<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> framework for Nim. Features include:</p> <ul><li>Efficient dispatch pipeline for asynchronous execution</li> <li>HTTP server with SSL/TLS support out of the box (no OpenSSL needed)</li> <li>Cancellation support</li> <li>Synchronization primitivies like queues, events and locks</li> <li>FIFO processing order of dispatch queue</li> <li>Minimal exception effect support (see <a href="#exception-effects">exception effects</a>)</li></ul> <h2 id="installation"><a href="#installation" class="header-anchor">#</a> Installation</h2> <p>You can use Nim's official package manager Nimble to install Chronos:</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>nimble install https://github.com/status-im/nim-chronos.git
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>or add a dependency to your <code>.nimble</code> file:</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>requires &quot;chronos&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="projects-using-chronos"><a href="#projects-using-chronos" class="header-anchor">#</a> Projects using <code>chronos</code></h2> <ul><li><a href="https://github.com/status-im/nim-libp2p" target="_blank" rel="noopener noreferrer">libp2p<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - Peer-to-Peer networking stack implemented in many languages</li> <li><a href="https://github.com/bung87/Looper" target="_blank" rel="noopener noreferrer">Looper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - Web framework</li> <li><a href="https://github.com/gogolxdong/2DeFi" target="_blank" rel="noopener noreferrer">2DeFi<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - Decentralised file system</li></ul> <p><code>chronos</code> is available in the <a href="https://play.nim-lang.org/#ix=2TpS" target="_blank" rel="noopener noreferrer">Nim Playground<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Submit a PR to add yours!</p> <h2 id="documentation"><a href="#documentation" class="header-anchor">#</a> Documentation</h2> <h3 id="concepts"><a href="#concepts" class="header-anchor">#</a> Concepts</h3> <p>Chronos implements the async/await paradigm in a self-contained library, using
macros, with no specific helpers from the compiler.</p> <p>Our event loop is called a &quot;dispatcher&quot; and a single instance per thread is
created, as soon as one is needed.</p> <p>To trigger a dispatcher's processing step, we need to call <code>poll()</code> - either
directly or through a wrapper like <code>runForever()</code> or <code>waitFor()</code>. This step
handles any file descriptors, timers and callbacks that are ready to be
processed.</p> <p><code>Future</code> objects encapsulate the result of an async procedure, upon successful
completion, and a list of callbacks to be scheduled after any type of
completion - be that success, failure or cancellation.</p> <p>(These explicit callbacks are rarely used outside Chronos, being replaced by
implicit ones generated by async procedure execution and <code>await</code> chaining.)</p> <p>Async procedures (those using the <code>{.async.}</code> pragma) return <code>Future</code> objects.</p> <p>Inside an async procedure, you can <code>await</code> the future returned by another async
procedure. At this point, control will be handled to the event loop until that
future is completed.</p> <p>Future completion is tested with <code>Future.finished()</code> and is defined as success,
failure or cancellation. This means that a future is either pending or completed.</p> <p>To differentiate between completion states, we have <code>Future.failed()</code> and
<code>Future.cancelled()</code>.</p> <h3 id="dispatcher"><a href="#dispatcher" class="header-anchor">#</a> Dispatcher</h3> <p>You can run the &quot;dispatcher&quot; event loop forever, with <code>runForever()</code> which is defined as:</p> <div class="language-nim line-numbers-mode"><pre class="language-nim"><code><span class="token keyword">proc</span> <span class="token function">runForever<span class="token operator">*</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span>
  <span class="token keyword">while</span> true<span class="token operator">:</span>
    <span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>You can also run it until a certain future is completed, with <code>waitFor()</code> which
will also call <code>Future.read()</code> on it:</p> <div class="language-nim line-numbers-mode"><pre class="language-nim"><code><span class="token keyword">proc</span> <span class="token function">p</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Future<span class="token punctuation">[</span>int<span class="token punctuation">]</span> <span class="token punctuation">{.</span>async<span class="token punctuation">.}</span> <span class="token operator">=</span>
  await <span class="token function">sleepAsync</span><span class="token punctuation">(</span><span class="token number">100.</span>milliseconds<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">1</span>

echo waitFor <span class="token function">p</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># prints &quot;1&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><code>waitFor()</code> is defined like this:</p> <div class="language-nim line-numbers-mode"><pre class="language-nim"><code><span class="token keyword">proc</span> <span class="token function">waitFor*[T]</span><span class="token punctuation">(</span>fut<span class="token operator">:</span> Future<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> T <span class="token operator">=</span>
  <span class="token keyword">while</span> <span class="token function">not</span><span class="token punctuation">(</span>fut<span class="token operator">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> fut<span class="token operator">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="async-procedures-and-methods"><a href="#async-procedures-and-methods" class="header-anchor">#</a> Async procedures and methods</h3> <p>The <code>{.async.}</code> pragma will transform a procedure (or a method) returning a
specialised <code>Future</code> type into a closure iterator. If there is no return type
specified, a <code>Future[void]</code> is returned.</p> <div class="language-nim line-numbers-mode"><pre class="language-nim"><code><span class="token keyword">proc</span> <span class="token function">p</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{.</span>async<span class="token punctuation">.}</span> <span class="token operator">=</span>
  await <span class="token function">sleepAsync</span><span class="token punctuation">(</span><span class="token number">100.</span>milliseconds<span class="token punctuation">)</span>

echo <span class="token function">p</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token keyword">type</span> <span class="token comment"># prints &quot;Future[system.void]&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Whenever <code>await</code> is encountered inside an async procedure, control is passed
back to the dispatcher for as many steps as it's necessary for the awaited
future to complete successfully, fail or be cancelled. <code>await</code> calls the
equivalent of <code>Future.read()</code> on the completed future and returns the
encapsulated value.</p> <div class="language-nim line-numbers-mode"><pre class="language-nim"><code><span class="token keyword">proc</span> <span class="token function">p1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{.</span>async<span class="token punctuation">.}</span> <span class="token operator">=</span>
  await <span class="token function">sleepAsync</span><span class="token punctuation">(</span><span class="token number">1.</span>seconds<span class="token punctuation">)</span>

<span class="token keyword">proc</span> <span class="token function">p2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{.</span>async<span class="token punctuation">.}</span> <span class="token operator">=</span>
  await <span class="token function">sleepAsync</span><span class="token punctuation">(</span><span class="token number">1.</span>seconds<span class="token punctuation">)</span>

<span class="token keyword">proc</span> <span class="token function">p3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{.</span>async<span class="token punctuation">.}</span> <span class="token operator">=</span>
  <span class="token keyword">let</span>
    fut1 <span class="token operator">=</span> <span class="token function">p1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fut2 <span class="token operator">=</span> <span class="token function">p2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment"># Just by executing the async procs, both resulting futures entered the</span>
  <span class="token comment"># dispatcher's queue and their &quot;clocks&quot; started ticking.</span>
  await fut1
  await fut2
  <span class="token comment"># Only one second passed while awaiting them both, not two.</span>

waitFor <span class="token function">p3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Don't let <code>await</code>'s behaviour of giving back control to the dispatcher surprise
you. If an async procedure modifies global state, and you can't predict when it
will start executing, the only way to avoid that state changing underneath your
feet, in a certain section, is to not use <code>await</code> in it.</p> <h3 id="error-handling"><a href="#error-handling" class="header-anchor">#</a> Error handling</h3> <p>Exceptions inheriting from <code>CatchableError</code> are caught by hidden <code>try</code> blocks
and placed in the <code>Future.error</code> field, changing the future's status to
<code>Failed</code>.</p> <p>When a future is awaited, that exception is re-raised, only to be caught again
by a hidden <code>try</code> block in the calling async procedure. That's how these
exceptions move up the async chain.</p> <p>A failed future's callbacks will still be scheduled, but it's not possible to
resume execution from the point an exception was raised.</p> <div class="language-nim line-numbers-mode"><pre class="language-nim"><code><span class="token keyword">proc</span> <span class="token function">p1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{.</span>async<span class="token punctuation">.}</span> <span class="token operator">=</span>
  await <span class="token function">sleepAsync</span><span class="token punctuation">(</span><span class="token number">1.</span>seconds<span class="token punctuation">)</span>
  <span class="token keyword">raise</span> <span class="token function">newException</span><span class="token punctuation">(</span>ValueError<span class="token punctuation">,</span> <span class="token string">&quot;ValueError inherits from CatchableError&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">proc</span> <span class="token function">p2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{.</span>async<span class="token punctuation">.}</span> <span class="token operator">=</span>
  await <span class="token function">sleepAsync</span><span class="token punctuation">(</span><span class="token number">1.</span>seconds<span class="token punctuation">)</span>

<span class="token keyword">proc</span> <span class="token function">p3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{.</span>async<span class="token punctuation">.}</span> <span class="token operator">=</span>
  <span class="token keyword">let</span>
    fut1 <span class="token operator">=</span> <span class="token function">p1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fut2 <span class="token operator">=</span> <span class="token function">p2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  await fut1
  echo <span class="token string">&quot;unreachable code here&quot;</span>
  await fut2

<span class="token comment"># `waitFor()` would call `Future.read()` unconditionally, which would raise the</span>
<span class="token comment"># exception in `Future.error`.</span>
<span class="token keyword">let</span> fut3 <span class="token operator">=</span> <span class="token function">p3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token function">not</span><span class="token punctuation">(</span>fut3<span class="token operator">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">:</span>
  <span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

echo <span class="token string">&quot;fut3.state = &quot;</span><span class="token punctuation">,</span> fut3<span class="token operator">.</span>state <span class="token comment"># &quot;Failed&quot;</span>
<span class="token keyword">if</span> fut3<span class="token operator">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
  echo <span class="token string">&quot;p3() failed: &quot;</span><span class="token punctuation">,</span> fut3<span class="token operator">.</span>error<span class="token operator">.</span>name<span class="token punctuation">,</span> <span class="token string">&quot;: &quot;</span><span class="token punctuation">,</span> fut3<span class="token operator">.</span>error<span class="token operator">.</span>msg
  <span class="token comment"># prints &quot;p3() failed: ValueError: ValueError inherits from CatchableError&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>You can put the <code>await</code> in a <code>try</code> block, to deal with that exception sooner:</p> <div class="language-nim line-numbers-mode"><pre class="language-nim"><code><span class="token keyword">proc</span> <span class="token function">p3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{.</span>async<span class="token punctuation">.}</span> <span class="token operator">=</span>
  <span class="token keyword">let</span>
    fut1 <span class="token operator">=</span> <span class="token function">p1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fut2 <span class="token operator">=</span> <span class="token function">p2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">try</span><span class="token operator">:</span>
    await fut1
  <span class="token keyword">except</span> CachableError<span class="token operator">:</span>
    echo <span class="token string">&quot;p1() failed: &quot;</span><span class="token punctuation">,</span> fut1<span class="token operator">.</span>error<span class="token operator">.</span>name<span class="token punctuation">,</span> <span class="token string">&quot;: &quot;</span><span class="token punctuation">,</span> fut1<span class="token operator">.</span>error<span class="token operator">.</span>msg
  echo <span class="token string">&quot;reachable code here&quot;</span>
  await fut2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Chronos does not allow that future continuations and other callbacks raise
<code>CatchableError</code> - as such, calls to <code>poll</code> will never raise exceptions caused
originating from tasks on the dispatcher queue. It is however possible that
<code>Defect</code> that happen in tasks bubble up through <code>poll</code> as these are not caught
by the transformation.</p> <h3 id="platform-independence"><a href="#platform-independence" class="header-anchor">#</a> Platform independence</h3> <p>Several functions in <code>chronos</code> are backed by the operating system, such as
waiting for network events, creating files and sockets etc. The specific
exceptions that are raised by the OS is platform-dependent, thus such functions
are declared as raising <code>CatchableError</code> but will in general raise something
more specific. In particular, it's possible that some functions that are
annotated as raising <code>CatchableError</code> only raise on <em>some</em> platforms - in order
to work on all platforms, calling code must assume that they will raise even
when they don't seem to do so on one platform.</p> <h3 id="exception-effects"><a href="#exception-effects" class="header-anchor">#</a> Exception effects</h3> <p><code>chronos</code> currently offers minimal support for exception effects and <code>raises</code>
annotations. In general, during the <code>async</code> transformation, a generic
<code>except CatchableError</code> handler is added around the entire function being
transformed, in order to catch any exceptions and transfer them to the <code>Future</code>.
Because of this, the effect system thinks no exceptions are &quot;leaking&quot; because in
fact, exception <em>handling</em> is deferred to when the future is being read.</p> <p>Effectively, this means that while code can be compiled with
<code>{.push raises: [Defect]}</code>, the intended effect propagation and checking is
<strong>disabled</strong> for <code>async</code> functions.</p> <p>To enable checking exception effects in <code>async</code> code, enable strict mode with
<code>-d:chronosStrictException</code>.</p> <p>In the strict mode, <code>async</code> functions are checked such that they only raise
<code>CatchableError</code> and thus must make sure to explicitly specify exception
effects on forward declarations, callbacks and methods using
<code>{.raises: [CatchableError].}</code> (or more strict) annotations.</p> <h2 id="todo"><a href="#todo" class="header-anchor">#</a> TODO</h2> <ul><li>Pipe/Subprocess Transports.</li> <li>Multithreading Stream/Datagram servers</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b6b895fe.js" defer></script><script src="/assets/js/2.fd7e9e0b.js" defer></script><script src="/assets/js/10.a7e5f96d.js" defer></script>
  </body>
</html>
